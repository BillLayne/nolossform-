<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NoLossForm.com</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 20px;
            overflow-y: auto;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 10px;
        }
        
        .nav-link {
            display: block;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav-link.active {
            background: rgba(255,255,255,0.2);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 30px;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            color: #333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.blue {
            background: #e3f2fd;
            color: #2196f3;
        }
        
        .stat-icon.green {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        .stat-icon.orange {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .stat-icon.purple {
            background: #f3e5f5;
            color: #9c27b0;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 12px;
            color: #4caf50;
        }
        
        .stat-change.negative {
            color: #f44336;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .chart-filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #f0f0f0;
        }
        
        td {
            padding: 12px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.completed {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        .status-badge.pending {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #f8f9fa;
        }
        
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 999;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">üìã NoLossForm</div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">üìä Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">üìù Submissions</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">üë• Agents</a>
            </li>
            <li class="nav-item">
                <a href="agent-portal.html" class="nav-link">üîó Generate Link</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">üìß Templates</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">‚öôÔ∏è Settings</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">üí≥ Billing</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">üìö Help</a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1>Dashboard</h1>
            <div class="user-info">
                <span id="agencyName">Bill Layne Insurance Agency</span>
                <div class="user-avatar">BL</div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Total Submissions</div>
                    <div class="stat-icon blue">üìã</div>
                </div>
                <div class="stat-value" id="totalSubmissions">1,247</div>
                <div class="stat-change">‚Üë 12% from last month</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">This Month</div>
                    <div class="stat-icon green">üìà</div>
                </div>
                <div class="stat-value" id="monthlySubmissions">142</div>
                <div class="stat-change">‚Üë 8% from last month</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Active Agents</div>
                    <div class="stat-icon orange">üë•</div>
                </div>
                <div class="stat-value" id="activeAgents">12</div>
                <div class="stat-change">2 added this month</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Completion Rate</div>
                    <div class="stat-icon purple">‚úÖ</div>
                </div>
                <div class="stat-value" id="completionRate">94%</div>
                <div class="stat-change">‚Üë 2% improvement</div>
            </div>
        </div>
        
        <!-- Chart Container -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Submissions Over Time</div>
                <div class="chart-filters">
                    <button class="filter-btn active">Week</button>
                    <button class="filter-btn">Month</button>
                    <button class="filter-btn">Year</button>
                </div>
            </div>
            <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: #999;">
                <canvas id="submissionsChart" width="100%" height="300"></canvas>
            </div>
        </div>
        
        <!-- Recent Submissions Table -->
        <div class="table-container">
            <div class="chart-header">
                <div class="chart-title">Recent Submissions</div>
                <button class="filter-btn">View All</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Policy #</th>
                        <th>Agent</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recentSubmissions">
                    <tr>
                        <td>Jan 13, 2025</td>
                        <td>John Smith</td>
                        <td>POL-123456</td>
                        <td>Jane Doe</td>
                        <td><span class="status-badge completed">Completed</span></td>
                        <td><button class="action-btn">View</button></td>
                    </tr>
                    <tr>
                        <td>Jan 13, 2025</td>
                        <td>Mary Johnson</td>
                        <td>POL-789012</td>
                        <td>Bob Wilson</td>
                        <td><span class="status-badge completed">Completed</span></td>
                        <td><button class="action-btn">View</button></td>
                    </tr>
                    <tr>
                        <td>Jan 12, 2025</td>
                        <td>Robert Brown</td>
                        <td>POL-345678</td>
                        <td>Jane Doe</td>
                        <td><span class="status-badge pending">Pending</span></td>
                        <td><button class="action-btn">View</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Add this as the FIRST line inside the <script> tag
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxP5rFSrbrDJ_3bFwi0xyBy054h5WkYBP89o54k5sEX7fk_8u0a74SbdHG0s3s32RDR/exec';

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (localStorage.getItem('agencyLoggedIn') !== 'true') {
                alert('Please login to access the dashboard');
                window.location.href = '/login.html';
                return;
            }

            // Add logout functionality to nav menu
            const navMenu = document.querySelector('.nav-menu');
            if (navMenu) {
                const logoutBtn = document.createElement('li');
                logoutBtn.innerHTML = '<a href="#" onclick="logout()">üö™ Logout</a>';
                navMenu.appendChild(logoutBtn);
            }

            // Load dashboard data
            loadDashboardData();
        });

        // Logout function
        function logout() {
            localStorage.removeItem('agencyLoggedIn');
            localStorage.removeItem('agencyEmail');
            window.location.href = '/login.html';
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // REPLACE the existing loadDashboardData function with this enhanced version
        async function loadDashboardData() {
            // Get agency profile from localStorage
            const agencyProfile = JSON.parse(localStorage.getItem('agencyProfile') || localStorage.getItem('agencyData') || '{}');

            if (!agencyProfile.agencyName) {
                // No agency data - keep existing behavior
                document.getElementById('agencyName').textContent = 'Your Agency';
                updateStats(); // Use mock data
                drawChart();
                return;
            }

            // Update agency name in header
            document.getElementById('agencyName').textContent = agencyProfile.agencyName;

            // Update user initials in avatar
            if (agencyProfile.firstName && agencyProfile.lastName) {
                const initials = agencyProfile.firstName[0] + agencyProfile.lastName[0];
                document.querySelector('.user-avatar').textContent = initials.toUpperCase();
            }

            try {
                // Show loading state
                document.getElementById('totalSubmissions').textContent = 'Loading...';
                document.getElementById('monthlySubmissions').textContent = '...';
                document.getElementById('activeAgents').textContent = '...';
                document.getElementById('completionRate').textContent = '...';

                // Fetch real data from Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_dashboard_data',
                        agencyName: agencyProfile.agencyName
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.status === 'success') {
                        // Update stats with real data
                        document.getElementById('totalSubmissions').textContent = result.stats.total.toLocaleString();
                        document.getElementById('monthlySubmissions').textContent = result.stats.thisMonth;
                        document.getElementById('completionRate').textContent = result.stats.completionRate + '%';

                        // Keep active agents as is (not tracked in submissions)
                        document.getElementById('activeAgents').textContent = agencyProfile.agents || '1';

                        // Update recent submissions table
                        updateSubmissionsTable(result.submissions);

                        // Draw chart with real data
                        drawChart();
                    } else {
                        // Error from backend - use mock data
                        console.error('Backend error:', result.message);
                        updateStats();
                    }
                } else {
                    // Network error - use mock data
                    console.error('Network error');
                    updateStats();
                }
            } catch (error) {
                // Any error - fallback to mock data
                console.error('Dashboard load error:', error);
                updateStats(); // Use existing mock data function
            }

            drawChart();
        }

        // ADD this new function after loadDashboardData
        function updateSubmissionsTable(submissions) {
            const tbody = document.getElementById('recentSubmissions');

            if (!submissions || submissions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">
                            No submissions yet. Generate your first Statement of No Loss link!
                        </td>
                    </tr>
                `;
                return;
            }

            // Clear existing rows
            tbody.innerHTML = '';

            // Add real submission data
            submissions.forEach(sub => {
                const row = document.createElement('tr');
                const date = new Date(sub.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${sub.customerName}</td>
                    <td>${sub.policyNumber}</td>
                    <td>${sub.agentName}</td>
                    <td><span class="status-badge ${sub.status.toLowerCase()}">${sub.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewSubmission('${sub.confirmationNumber}')">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ADD this helper function for viewing submissions
        function viewSubmission(confirmationNumber) {
            alert('Confirmation #: ' + confirmationNumber + '\n\nView functionality coming soon!');
        }
        
        function updateStats() {
            // In production, these would come from your Google Sheets API
            const stats = {
                totalSubmissions: Math.floor(Math.random() * 2000) + 500,
                monthlySubmissions: Math.floor(Math.random() * 200) + 50,
                activeAgents: Math.floor(Math.random() * 20) + 5,
                completionRate: Math.floor(Math.random() * 10) + 90
            };
            
            document.getElementById('totalSubmissions').textContent = stats.totalSubmissions.toLocaleString();
            document.getElementById('monthlySubmissions').textContent = stats.monthlySubmissions;
            document.getElementById('activeAgents').textContent = stats.activeAgents;
            document.getElementById('completionRate').textContent = stats.completionRate + '%';
        }
        
        function drawChart() {
            const canvas = document.getElementById('submissionsChart');
            const ctx = canvas.getContext('2d');
            
            // Simple bar chart
            const data = [65, 78, 90, 81, 95, 89, 76];
            const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const maxValue = Math.max(...data);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            const barWidth = canvas.width / data.length * 0.6;
            const spacing = canvas.width / data.length * 0.4;
            
            ctx.fillStyle = '#667eea';
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * 250;
                const x = index * (barWidth + spacing) + spacing / 2;
                const y = canvas.height - barHeight - 30;
                
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw labels
                ctx.fillStyle = '#666';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(labels[index], x + barWidth / 2, canvas.height - 10);
                ctx.fillText(value, x + barWidth / 2, y - 5);
                
                ctx.fillStyle = '#667eea';
            });
        }
        
        // Handle filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from siblings
                this.parentElement.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                // Redraw chart with new data
                drawChart();
            });
        });
        
        // Auto-refresh every 30 seconds (only if we have agency data)
        setInterval(() => {
            const agencyProfile = localStorage.getItem('agencyProfile') || localStorage.getItem('agencyData');
            if (agencyProfile) {
                loadDashboardData(); // This will now fetch real data
            }
        }, 30000);
    </script>
</body>
</html>
