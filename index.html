<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement of No Loss</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Language Toggle Styles */
        .language-toggle {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 8px;
        }
        
        .lang-btn {
            padding: 5px 12px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .lang-btn.active {
            background: white;
            color: #2a5298;
        }
        
        .lang-btn:hover:not(.active) {
            background: rgba(255,255,255,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .header h2 {
            font-size: 20px;
            font-weight: 400;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .agent-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .form-container {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .statement-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .statement-box h3 {
            color: #2a5298;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .statement-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .signature-container {
            margin: 25px 0;
        }
        
        .signature-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #signature-pad {
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: block;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-clear {
            background: #f44336;
            color: white;
            flex: 1;
        }
        
        .btn-clear:hover {
            background: #da190b;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            margin-top: 20px;
            font-size: 18px;
            padding: 15px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .success-message,
        .error-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .success-message {
            background: #4CAF50;
            color: white;
        }
        
        .error-message {
            background: #f44336;
            color: white;
        }
        
        /* Success Modal Styles */
        .success-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .success-modal-overlay.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .success-modal {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease-out 0.2s both;
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            animation: drawCheck 0.6s ease-out 0.5s both;
        }
        
        .success-modal h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .success-modal p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        
        .success-modal .confirmation-number {
            background: #f0f4ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-family: monospace;
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }
        
        .success-modal .btn-ok {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            padding: 12px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .success-modal .btn-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }
        
        @keyframes drawCheck {
            from {
                stroke-dasharray: 50;
                stroke-dashoffset: 50;
            }
            to {
                stroke-dasharray: 50;
                stroke-dashoffset: 0;
            }
        }
        
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .footer img {
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        
        .footer p {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        .autofill-notice {
            background: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
            margin-bottom: 20px;
            border-radius: 8px;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 24px;
            }
            
            .header h2 {
                font-size: 18px;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="date"],
            select {
                font-size: 16px;
                padding: 14px 12px;
            }
            
            .success-modal {
                width: 95%;
                padding: 30px 20px;
            }
            
            .success-icon {
                width: 60px;
                height: 60px;
            }
            
            .success-icon svg {
                width: 30px;
                height: 30px;
            }
            
            .language-toggle {
                position: static;
                margin-bottom: 10px;
                justify-content: center;
                background: rgba(255,255,255,0.1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="language-toggle">
                <button class="lang-btn active" onclick="setLanguage('en', event)">English</button>
                <button class="lang-btn" onclick="setLanguage('es', event)">Espa√±ol</button>
            </div>
            <!-- Dynamic Agency Name -->
            <h1 id="agencyHeader">Statement of No Loss</h1>
            <h2 data-lang="header-title">Insurance Reinstatement Form</h2>
            <p data-lang="header-subtitle">Electronic Signature Authorization</p>
            <!-- Agent info section -->
            <div id="agentInfoDisplay" class="agent-info" style="display: none;">
                <strong>Your Agent:</strong> <span id="agentNameDisplay"></span><br>
                <span id="agentEmailDisplay"></span>
            </div>
        </div>
        
        <form id="noLossForm" class="form-container">
            <div class="autofill-notice" id="autofillNotice">
                <span data-lang="autofill-notice">‚ú® Form has been pre-filled with your information</span>
            </div>
            
            <div class="form-group">
                <label for="insuranceCompany" data-lang="label-company">Insurance Company *</label>
                <select id="insuranceCompany" name="insuranceCompany" required>
                    <option value="" data-lang="select-company">Select Insurance Company</option>
                    <option value="Nationwide">Nationwide</option>
                    <option value="Progressive">Progressive</option>
                    <option value="National General">National General</option>
                    <option value="Alamance">Alamance</option>
                    <option value="Travelers">Travelers</option>
                    <option value="Foremost">Foremost</option>
                    <option value="Other" data-lang="option-other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="policyNumber" data-lang="label-policy">Policy Number *</label>
                <input type="text" id="policyNumber" name="policyNumber" required placeholder="Enter policy number">
            </div>
            
            <div class="form-group">
                <label for="insuredName" data-lang="label-name">Insured Name (Full Name) *</label>
                <input type="text" id="insuredName" name="insuredName" required placeholder="John Doe">
            </div>
            
            <div class="form-group">
                <label for="email" data-lang="label-email">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label for="phone" data-lang="label-phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required placeholder="(336) 555-1234">
            </div>
            
            <div class="form-group">
                <label for="cancellationDate" data-lang="label-cancel-date">Cancellation/Lapse Date *</label>
                <input type="date" id="cancellationDate" name="cancellationDate" required>
            </div>
            
            <div class="form-group">
                <label for="reinstatementDate" data-lang="label-reinstate-date">Requested Reinstatement Date *</label>
                <input type="date" id="reinstatementDate" name="reinstatementDate" required>
            </div>
            
            <div class="form-group">
                <label for="policyType" data-lang="label-policy-type">Policy Type *</label>
                <select id="policyType" name="policyType" required>
                    <option value="" data-lang="select-policy-type">Select Policy Type</option>
                    <option value="Auto" data-lang="option-auto">Auto Insurance</option>
                    <option value="Home" data-lang="option-home">Homeowners Insurance</option>
                    <option value="Renters" data-lang="option-renters">Renters Insurance</option>
                    <option value="Life" data-lang="option-life">Life Insurance</option>
                    <option value="Business" data-lang="option-business">Business Insurance</option>
                    <option value="Other" data-lang="option-other2">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="amountPaid" data-lang="label-amount">Amount Paid for Reinstatement *</label>
                <input type="text" id="amountPaid" name="amountPaid" required placeholder="$0.00">
            </div>
            
            <div class="statement-box">
                <h3 data-lang="statement-title">üìã Statement of No Loss</h3>
                <div data-lang="statement-text">
                    <p>
                        I state that neither I nor any other person covered by this policy has had a claim or loss or been involved in an accident since the cancellation or expiration of the policy (otherwise known as the "no loss period") wherein this policy, including any and all coverages endorsed upon or made part of the policy may apply. In addition, if this reinstatement is for a personal or commercial auto, motorcycle, or RV policy, I certify that I have disclosed the current garaging location and use of all insured vehicles including if any such vehicle is used to deliver food or goods, to transport people for compensation, or for any other business purpose. I have also disclosed household members who are age 14 or older, and all persons who regularly drive any vehicle insured under this policy.
                    </p>
                    <p style="margin-top: 10px;">
                        I understand that this insurance company is relying solely upon this Statement of No Loss all of which is material, as an inducement to reinstate my policy with no lapse in coverage. I further understand that if a claim, loss, or accident has occurred during the no loss period, or if I failed to disclose the current garaging location and primary use of all vehicles insured under this policy, all persons who regularly drive these vehicles, and all members of my household who are age 14 or older, the reinstatement is null and void, my policy remains cancelled and no insurance coverage shall be provided.
                    </p>
                    <p style="margin-top: 10px;">
                        I agree that if my check or other payment for this reinstatement is not honored for any reason, the reinstatement is null and void and no coverage shall exist under this policy. I agree to pay a reinstatement fee and late fee (if applicable) in addition to the premium required to reinstate my policy. My payment will be applied first to the reinstatement and late fee and the remainder to the premium.
                    </p>
                    <p style="margin-top: 10px; font-weight: bold;">
                        It is a crime to knowingly provide false, incomplete, or misleading information to an insurance company for the purpose of defrauding the company. Penalties include imprisonment, fines, and denial of insurance benefits.
                    </p>
                    <p style="margin-top: 10px; font-weight: bold;">
                        Do you understand and agree to these statements, terms, and conditions?
                    </p>
                </div>
            </div>
            
            <div class="form-group" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <label style="display: flex; align-items: flex-start; cursor: pointer; font-weight: normal;">
                    <input type="checkbox" id="agreeTerms" name="agreeTerms" required style="width: auto; margin-right: 10px; margin-top: 3px; transform: scale(1.2);">
                    <span style="color: #333; font-size: 15px; line-height: 1.5;" data-lang="agree-checkbox">
                        I have read, understand, and agree to all the statements, terms, and conditions outlined above in the Statement of No Loss.
                    </span>
                </label>
            </div>
            
            <div class="signature-container">
                <div class="signature-label">
                    <label data-lang="label-signature">Electronic Signature *</label>
                    <span style="color: #666; font-size: 12px;" data-lang="signature-instruction">Draw your signature below</span>
                </div>
                <canvas id="signature-pad"></canvas>
                <div class="signature-buttons">
                    <button type="button" class="btn btn-clear" onclick="clearSignature()" data-lang="btn-clear">Clear Signature</button>
                </div>
            </div>
            
            <!-- Hidden fields for form data -->
            <input type="hidden" id="signature" name="signature">
            <input type="hidden" id="confirmationNumber" name="confirmationNumber">
            
            <!-- CRITICAL: Hidden fields for agency info -->
            <input type="hidden" id="agencyName" name="agencyName" value="">
            <input type="hidden" id="agentName" name="agentName" value="">
            <input type="hidden" id="agentEmail" name="agentEmail" value="">
            
            <div class="success-message" id="successMessage">
                <span data-lang="success-msg">‚úÖ Your Statement of No Loss has been successfully submitted!</span>
            </div>
            
            <div class="error-message" id="errorMessage">
                <span data-lang="error-msg">‚ùå There was an error submitting your form. Please try again.</span>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;" data-lang="loading-msg">Submitting your statement...</p>
            </div>
            
            <button type="submit" class="btn btn-submit" id="submitBtn" data-lang="btn-submit">
                Submit Statement of No Loss
            </button>
        </form>
        
        <div class="footer" id="footerInfo">
            <p>
                <span id="footerAgencyName">NoLossForm.com</span><br>
                <span id="footerContact">Statement of No Loss Platform</span>
            </p>
            <p style="margin-top: 10px; font-size: 11px; color: #999;">
                Powered by NoLossForm.com
            </p>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal-overlay" id="successModalOverlay">
        <div class="success-modal">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h2 data-lang="modal-title">Successfully Submitted!</h2>
            <p data-lang="modal-text">Your Statement of No Loss has been received and processed successfully.</p>
            <div class="confirmation-number" id="confirmationDisplay">
                <span data-lang="modal-confirmation">Confirmation #:</span> <span id="confirmNumber"></span>
            </div>
            <p style="font-size: 14px; color: #888;" data-lang="modal-email">
                A confirmation email has been sent to your registered email address.
            </p>
            <button class="btn-ok" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script>
        // CRITICAL: Update this with YOUR Google Apps Script URL from the deployment
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMR6JkqwOFjLUR4BRo7QE0mRiEwKxbcpdCDwJi5AKOmM4MMorM1EROWYMcH7gH1Vke/exec';
        
        let signaturePad;
        let currentConfirmationNumber = '';
        let currentLanguage = 'en';
        
        // Global storage for agency info from URL
        let urlAgencyInfo = {
            agencyName: '',
            agentName: '',
            agentEmail: ''
        };
        
        // Language translations
        const translations = {
            en: {
                'header-title': 'Insurance Reinstatement Form',
                'header-subtitle': 'Electronic Signature Authorization',
                'autofill-notice': '‚ú® Form has been pre-filled with your information',
                'label-company': 'Insurance Company *',
                'select-company': 'Select Insurance Company',
                'option-other': 'Other',
                'label-policy': 'Policy Number *',
                'label-name': 'Insured Name (Full Name) *',
                'label-email': 'Email Address *',
                'label-phone': 'Phone Number *',
                'label-cancel-date': 'Cancellation/Lapse Date *',
                'label-reinstate-date': 'Requested Reinstatement Date *',
                'label-policy-type': 'Policy Type *',
                'select-policy-type': 'Select Policy Type',
                'option-auto': 'Auto Insurance',
                'option-home': 'Homeowners Insurance',
                'option-renters': 'Renters Insurance',
                'option-life': 'Life Insurance',
                'option-business': 'Business Insurance',
                'option-other2': 'Other',
                'label-amount': 'Amount Paid for Reinstatement *',
                'statement-title': 'üìã Statement of No Loss',
                'agree-checkbox': 'I have read, understand, and agree to all the statements, terms, and conditions outlined above in the Statement of No Loss.',
                'label-signature': 'Electronic Signature *',
                'signature-instruction': 'Draw your signature below',
                'btn-clear': 'Clear Signature',
                'btn-submit': 'Submit Statement of No Loss',
                'success-msg': '‚úÖ Your Statement of No Loss has been successfully submitted!',
                'error-msg': '‚ùå There was an error submitting your form. Please try again.',
                'loading-msg': 'Submitting your statement...',
                'modal-title': 'Successfully Submitted!',
                'modal-text': 'Your Statement of No Loss has been received and processed successfully.',
                'modal-confirmation': 'Confirmation #:',
                'modal-email': 'A confirmation email has been sent to your registered email address.',
                'alert-agree': 'Please check the box to agree to the terms and conditions before submitting.',
                'alert-signature': 'Please provide your signature before submitting.'
            },
            es: {
                'header-title': 'Formulario de Reinstalaci√≥n de Seguro',
                'header-subtitle': 'Autorizaci√≥n de Firma Electr√≥nica',
                'autofill-notice': '‚ú® El formulario ha sido prellenado con su informaci√≥n',
                'label-company': 'Compa√±√≠a de Seguros *',
                'select-company': 'Seleccione Compa√±√≠a de Seguros',
                'option-other': 'Otra',
                'label-policy': 'N√∫mero de P√≥liza *',
                'label-name': 'Nombre del Asegurado (Nombre Completo) *',
                'label-email': 'Correo Electr√≥nico *',
                'label-phone': 'N√∫mero de Tel√©fono *',
                'label-cancel-date': 'Fecha de Cancelaci√≥n/Vencimiento *',
                'label-reinstate-date': 'Fecha de Reinstalaci√≥n Solicitada *',
                'label-policy-type': 'Tipo de P√≥liza *',
                'select-policy-type': 'Seleccione Tipo de P√≥liza',
                'option-auto': 'Seguro de Auto',
                'option-home': 'Seguro de Propietario',
                'option-renters': 'Seguro de Inquilino',
                'option-life': 'Seguro de Vida',
                'option-business': 'Seguro de Negocio',
                'option-other2': 'Otro',
                'label-amount': 'Cantidad Pagada para Reinstalaci√≥n *',
                'statement-title': 'üìã Declaraci√≥n de No P√©rdida',
                'agree-checkbox': 'He le√≠do, entiendo y acepto todas las declaraciones, t√©rminos y condiciones descritos anteriormente en la Declaraci√≥n de No P√©rdida.',
                'label-signature': 'Firma Electr√≥nica *',
                'signature-instruction': 'Dibuje su firma abajo',
                'btn-clear': 'Borrar Firma',
                'btn-submit': 'Enviar Declaraci√≥n de No P√©rdida',
                'success-msg': '‚úÖ ¬°Su Declaraci√≥n de No P√©rdida ha sido enviada exitosamente!',
                'error-msg': '‚ùå Hubo un error al enviar su formulario. Por favor intente de nuevo.',
                'loading-msg': 'Enviando su declaraci√≥n...',
                'modal-title': '¬°Enviado Exitosamente!',
                'modal-text': 'Su Declaraci√≥n de No P√©rdida ha sido recibida y procesada exitosamente.',
                'modal-confirmation': 'N√∫mero de Confirmaci√≥n:',
                'modal-email': 'Se ha enviado un correo de confirmaci√≥n a su direcci√≥n de correo electr√≥nico registrada.',
                'alert-agree': 'Por favor marque la casilla para aceptar los t√©rminos y condiciones antes de enviar.',
                'alert-signature': 'Por favor proporcione su firma antes de enviar.'
            }
        };
        
        // Language switching
        function setLanguage(lang, event) {
            currentLanguage = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const langButton = document.querySelector(`.lang-btn[onclick*="'${lang}'"]`);
                if (langButton) {
                    langButton.classList.add('active');
                }
            }
            
            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            localStorage.setItem('preferredLanguage', lang);
        }
        
        // CRITICAL FUNCTION: Get URL parameters and extract agency info
        function getUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const paramObject = {};
            for (const [key, value] of params) {
                paramObject[key] = decodeURIComponent(value);
            }
            return paramObject;
        }
        
        // CRITICAL FUNCTION: Auto-fill form and capture agency info
        function autoFillForm() {
            const params = getUrlParameters();
            let fieldsAutoFilled = false;
            
            console.log('URL Parameters received:', params);
            
            // CRITICAL: Capture agency information from URL
            if (params.agencyName) {
                urlAgencyInfo.agencyName = params.agencyName;
                document.getElementById('agencyName').value = params.agencyName;
                document.getElementById('agencyHeader').textContent = params.agencyName;
                document.getElementById('footerAgencyName').textContent = params.agencyName;
                console.log('Agency Name set to:', params.agencyName);
            }
            
            if (params.agentName) {
                urlAgencyInfo.agentName = params.agentName;
                document.getElementById('agentName').value = params.agentName;
                document.getElementById('agentNameDisplay').textContent = params.agentName;
                document.getElementById('agentInfoDisplay').style.display = 'block';
            }
            
            if (params.agentEmail) {
                urlAgencyInfo.agentEmail = params.agentEmail;
                document.getElementById('agentEmail').value = params.agentEmail;
                if (params.agentName) {
                    document.getElementById('agentEmailDisplay').textContent = params.agentEmail;
                }
            }
            
            // Field mappings for form auto-fill
            const fieldMapping = {
                'insuredName': 'insuredName',
                'email': 'email',
                'phone': 'phone',
                'insuranceCompany': 'insuranceCompany',
                'policyNumber': 'policyNumber',
                'policyType': 'policyType',
                'cancellationDate': 'cancellationDate',
                'reinstatementDate': 'reinstatementDate',
                'amountPaid': 'amountPaid',
                'customerName': 'insuredName',
                'name': 'insuredName',
                'company': 'insuranceCompany',
                'policy': 'policyNumber',
                'tel': 'phone',
                'cancelDate': 'cancellationDate',
                'reinstateDate': 'reinstatementDate',
                'type': 'policyType',
                'amount': 'amountPaid'
            };
            
            // Fill form fields
            for (const [urlParam, fieldId] of Object.entries(fieldMapping)) {
                if (params[urlParam]) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = params[urlParam];
                        fieldsAutoFilled = true;
                        
                        if (fieldId === 'amountPaid' && !params[urlParam].startsWith('$')) {
                            field.value = '$' + params[urlParam];
                        }
                    }
                }
            }
            
            // Show notification if fields were auto-filled
            if (fieldsAutoFilled) {
                const notice = document.getElementById('autofillNotice');
                notice.style.display = 'block';
                setTimeout(() => {
                    notice.style.opacity = '0';
                    setTimeout(() => {
                        notice.style.display = 'none';
                        notice.style.opacity = '1';
                    }, 500);
                }, 3000);
            }
        }
        
        // Generate confirmation number
        function generateConfirmationNumber() {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `NOL-${year}${month}${day}-${random}`;
        }
        
        // Modal functions
        function closeSuccessModal() {
            document.getElementById('successModalOverlay').classList.remove('show');
        }
        
        function showSuccessModal() {
            document.getElementById('confirmNumber').textContent = currentConfirmationNumber;
            document.getElementById('successModalOverlay').classList.add('show');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check language preference
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            if (langParam === 'es') {
                setLanguage('es');
            } else {
                const savedLang = localStorage.getItem('preferredLanguage');
                if (savedLang && savedLang !== 'en') {
                    setLanguage(savedLang);
                }
            }
            
            // CRITICAL: Auto-fill form and capture agency info
            autoFillForm();
            
            // Initialize signature pad
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Modal close on outside click
            document.getElementById('successModalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSuccessModal();
                }
            });
        });
        
        function resizeCanvas() {
            const canvas = document.getElementById('signature-pad');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            if (signaturePad) {
                signaturePad.clear();
            }
        }
        
        function clearSignature() {
            signaturePad.clear();
        }
        
        // CRITICAL: Form submission handler with agency info
        document.getElementById('noLossForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate agreement
            if (!document.getElementById('agreeTerms').checked) {
                alert(translations[currentLanguage]['alert-agree']);
                return;
            }
            
            // Validate signature
            if (signaturePad.isEmpty()) {
                alert(translations[currentLanguage]['alert-signature']);
                return;
            }
            
            // Generate confirmation number
            currentConfirmationNumber = generateConfirmationNumber();
            
            // Get signature data
            document.getElementById('signature').value = signaturePad.toDataURL();
            document.getElementById('confirmationNumber').value = currentConfirmationNumber;
            
            // CRITICAL: Ensure agency info is in hidden fields
            document.getElementById('agencyName').value = urlAgencyInfo.agencyName || 'NoLossForm.com';
            document.getElementById('agentName').value = urlAgencyInfo.agentName || '';
            document.getElementById('agentEmail').value = urlAgencyInfo.agentEmail || '';
            
            console.log('Submitting with agency:', document.getElementById('agencyName').value);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Prepare form data
            const formData = new FormData(this);
            formData.append('submissionDate', new Date().toLocaleString());
            
            // Debug what we're sending
            console.log('Form data being sent:');
            for (let [key, value] of formData.entries()) {
                if (key === 'agencyName' || key === 'agentName' || key === 'agentEmail') {
                    console.log(key + ':', value);
                }
            }
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.text();
                console.log('Response:', result);
                
                if (result.includes('Success') || result.includes('success') || response.ok) {
                    showSuccessModal();
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('noLossForm').reset();
                    signaturePad.clear();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    throw new Error('Submission failed');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        // Phone number formatting
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = '(' + value;
                } else if (value.length <= 6) {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
                } else {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
                }
            }
            e.target.value = value;
        });
        
        // Amount formatting
        document.getElementById('amountPaid').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d.]/g, '');
            let parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].slice(0, 2);
            }
            if (value && !e.target.value.startsWith('$')) {
                e.target.value = '$' + value;
            } else if (value === '') {
                e.target.value = '';
            }
        });
        
        document.getElementById('amountPaid').addEventListener('blur', function(e) {
            let value = e.target.value.replace(/[^\d.]/g, '');
            if (value) {
                let num = parseFloat(value);
                if (!isNaN(num)) {
                    e.target.value = '$' + num.toFixed(2);
                }
            }
        });
    </script>
</body>
</html>
